
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Musico — YouTube Music Player</title>
  <meta name="theme-color" content="#0b0b0c" />
  <!-- Font Awesome 6 - Latest Version -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Firebase SDKs (Compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    :root{
      --bg: #0a0a0b;
      --bg-elev: #111115;
      --card: #1a1a1f;
      --card-hover: #212128;
      --muted: #9ca3af;
      --text: #f1f5f9;
      --accent: #6366f1;
      --accent-hover: #5855eb;
      --accent-2: #06b6d4;
      --youtube-red: #ff0000;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --radius: 20px;
      --radius-sm: 12px;
      --shadow: 0 20px 50px rgba(0,0,0,.4);
      --shadow-lg: 0 25px 60px rgba(0,0,0,.6);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      background: 
        radial-gradient(circle at 20% 20%, rgba(99,102,241,.15) 0%, transparent 60%),
        radial-gradient(circle at 80% 80%, rgba(6,182,212,.12) 0%, transparent 60%),
        radial-gradient(circle at 40% 60%, rgba(139,92,246,.08) 0%, transparent 60%),
        var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.6;
      overflow: hidden;
    }

    .app {
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: 1fr auto;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      background: rgba(26,26,31,.8);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255,255,255,.08);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 20px;
      margin-bottom: 12px;
    }

    .brand .logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--youtube-red), #ff4444);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      box-shadow: var(--shadow);
    }

    .sidebar-card {
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.1);
      border-radius: var(--radius);
      padding: 20px;
      backdrop-filter: blur(10px);
    }

    .card-title {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }

    .search-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .search-input {
      width: 100%;
      background: rgba(255,255,255,.06);
      border: 2px solid rgba(255,255,255,.1);
      color: var(--text);
      padding: 14px 16px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      transition: all .3s ease;
      outline: none;
    }

    .search-input:focus {
      border-color: var(--accent);
      background: rgba(255,255,255,.1);
      box-shadow: 0 0 0 3px rgba(99,102,241,.2);
    }

    .search-input::placeholder {
      color: var(--muted);
    }

    /* Buttons */
    .btn {
      appearance: none;
      border: none;
      outline: none;
      background: var(--card);
      color: var(--text);
      padding: 14px 20px;
      border-radius: var(--radius-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all .3s ease;
      font-weight: 600;
      font-size: 14px;
      min-height: 48px;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.1), transparent);
      transition: left .6s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: white;
      box-shadow: 0 8px 25px rgba(99,102,241,.3);
    }

    .btn.youtube {
      background: linear-gradient(135deg, var(--youtube-red), #e60000);
      color: white;
      box-shadow: 0 8px 25px rgba(255,0,0,.3);
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
      transform: none;
    }

    .btn i {
      font-size: 16px;
    }

    /* Content Area */
    .content {
      position: relative;
      overflow: auto;
      background: rgba(17,17,21,.3);
    }

    .header {
      position: sticky;
      top: 0;
      background: rgba(26,26,31,.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      z-index: 10;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-bar {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .badge {
      padding: 6px 16px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.05);
    }

    .badge.success {
      background: rgba(16,185,129,.2);
      border-color: rgba(16,185,129,.3);
      color: var(--success);
    }

    .badge.error {
      background: rgba(239,68,68,.2);
      border-color: rgba(239,68,68,.3);
      color: var(--error);
    }

    /* Results Grid */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
      padding: 24px;
    }

    .track-card {
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.1);
      border-radius: var(--radius);
      overflow: hidden;
      transition: all .4s ease;
      cursor: pointer;
      position: relative;
    }

    .track-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-lg);
      border-color: rgba(255,255,255,.2);
    }

    .track-thumb {
      width: 100%;
      height: 200px;
      position: relative;
      overflow: hidden;
    }

    .track-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform .4s ease;
    }

    .track-card:hover .track-thumb img {
      transform: scale(1.1);
    }

    .play-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(0,0,0,.8), rgba(0,0,0,.6));
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all .3s ease;
    }

    .track-card:hover .play-overlay {
      opacity: 1;
    }

    .play-button {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 32px;
      border: none;
      cursor: pointer;
      transition: all .3s ease;
      box-shadow: 0 10px 30px rgba(99,102,241,.4);
    }

    .play-button:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 40px rgba(99,102,241,.6);
    }

    .track-info {
      padding: 20px;
    }

    .track-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
    }

    .track-channel {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 12px;
    }

    .track-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255,255,255,.1);
      color: var(--text);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all .3s ease;
      font-size: 16px;
    }

    .icon-btn:hover {
      background: rgba(255,255,255,.2);
      transform: scale(1.1);
    }

    .icon-btn.added {
      background: var(--success);
      color: white;
    }

    /* Player */
    .player {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, rgba(26,26,31,.98), rgba(17,17,21,.98));
      backdrop-filter: blur(30px);
      border-top: 1px solid rgba(255,255,255,.1);
      display: grid;
      grid-template-columns: 320px 1fr 320px;
      gap: 24px;
      align-items: center;
      padding: 20px 24px;
    }

    .now-playing {
      display: flex;
      align-items: center;
      gap: 16px;
      min-width: 0;
    }

    .np-thumb {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--card);
      flex-shrink: 0;
      box-shadow: var(--shadow);
    }

    .np-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .np-info {
      min-width: 0;
      flex: 1;
    }

    .np-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .np-artist {
      color: var(--muted);
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }

    .control-buttons {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .control-btn {
      width: 48px;
      height: 48px;
      border: none;
      background: rgba(255,255,255,.1);
      color: var(--text);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all .3s ease;
      font-size: 18px;
    }

    .control-btn:hover {
      background: rgba(255,255,255,.2);
      transform: scale(1.1);
    }

    .control-btn.active {
      background: var(--accent);
      color: white;
    }

    .control-btn.play {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      font-size: 24px;
      box-shadow: 0 8px 25px rgba(99,102,241,.4);
    }

    .control-btn.play:hover {
      transform: scale(1.15);
      box-shadow: 0 12px 35px rgba(99,102,241,.6);
    }

    .seek-container {
      display: flex;
      align-items: center;
      gap: 16px;
      width: 100%;
      max-width: 500px;
    }

    .time-display {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      min-width: 40px;
      text-align: center;
    }

    /* Range Sliders */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,.2);
      border-radius: 999px;
      outline: none;
      cursor: pointer;
      transition: all .3s ease;
    }

    input[type="range"]:hover {
      background: rgba(255,255,255,.3);
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(99,102,241,.4);
      transition: all .3s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 6px 16px rgba(99,102,241,.6);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(99,102,241,.4);
    }

    .volume-container {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 160px;
    }

    .volume-icon {
      color: var(--muted);
      font-size: 18px;
      min-width: 24px;
    }

    .volume-slider {
      width: 120px;
    }

    /* Loading and Empty States */
    .loading, .empty {
      text-align: center;
      padding: 80px 24px;
      color: var(--muted);
    }

    .loading .spinner {
      font-size: 48px;
      color: var(--accent);
      margin-bottom: 24px;
      animation: spin 2s linear infinite;
    }

    .empty h2 {
      font-size: 32px;
      margin-bottom: 16px;
      color: var(--text);
    }

    .empty .icon {
      font-size: 64px;
      color: var(--youtube-red);
      margin-bottom: 24px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Queue Info */
    .queue-status {
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(255,255,255,.05);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.1);
    }

    /* Tips */
    .tips-list {
      font-size: 13px;
      line-height: 1.8;
      color: var(--muted);
    }

    .tips-list i {
      width: 16px;
      color: var(--accent);
      margin-right: 4px;
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
      }
      
      .sidebar {
        display: none;
      }
      
      .player {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        gap: 20px;
        padding: 20px;
      }
      
      .volume-container {
        justify-content: center;
      }
      
      .results-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        padding: 20px;
      }
    }

    @media (max-width: 640px) {
      .results-grid {
        grid-template-columns: 1fr;
        padding: 16px;
      }
      
      .track-thumb {
        height: 240px;
      }
      
      .page-title {
        font-size: 20px;
      }
      
      .topbar {
        padding: 16px 20px;
      }
    }

    /* Hidden YouTube Player */
    #youtube-player {
      position: fixed;
      top: -9999px;
      left: -9999px;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,.05);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.2);
      border-radius: 4px;
      transition: background .3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,.4);
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    /* Toast */
    .toast{position:fixed;right:20px;bottom:20px;background:rgba(26,26,31,.95);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px 16px;box-shadow:var(--shadow);z-index:9999;display:none}
    .toast.show{display:block;animation:fadeIn .2s ease}
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">
          <i class="fab fa-youtube"></i>
        </div>
        <div>
          <div>Musico</div>
          <div style="font-size: 12px; color: var(--muted);">YouTube Music Player</div>
        </div>
      </div>

      <!-- Search Section -->
      <div class="sidebar-card">
        <div class="card-title">
          <i class="fas fa-search"></i>
          Search Music
        </div>
        <div class="search-container">
          <input type="text" id="searchInput" class="search-input" placeholder="Search songs, artists, albums..." />
          <button class="btn youtube" id="searchBtn">
            <i class="fas fa-search"></i>
            Search YouTube
          </button>
        </div>
      </div>

      <!-- Queue Info -->
      <div class="sidebar-card">
        <div class="card-title">
          <i class="fas fa-list-ul"></i>
          Queue Status
        </div>
        <div id="queueInfo" class="queue-status">No songs in queue</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="btnClearQueue"><i class="fas fa-broom"></i> Clear Queue</button>
        </div>
      </div>

      <!-- Controls Help -->
      <div class="sidebar-card">
        <div class="card-title">
          <i class="fas fa-keyboard"></i>
          Keyboard Shortcuts
        </div>
        <div class="tips-list">
          <div><i class="fas fa-play"></i> Space - Play/Pause</div>
          <div><i class="fas fa-arrow-left"></i><i class="fas fa-arrow-right"></i> ←/→ - Seek ±10s</div>
          <div><i class="fas fa-arrow-up"></i><i class="fas fa-arrow-down"></i> ↑/↓ - Volume ±5</div>
          <div><i class="fas fa-step-forward"></i> N - Next Track</div>
          <div><i class="fas fa-step-backward"></i> P - Previous Track</div>
        </div>
      </div>

      <!-- Project Info -->
      <div class="sidebar-card">
        <div class="card-title">
          <i class="fas fa-info-circle"></i>
          About
        </div>
        <div style="font-size: 13px; color: var(--muted); line-height: 1.6;">
          Modern YouTube music player built with YouTube Data API v3. Educational project showcasing modern web technologies and responsive design.
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="content">
      <header class="header">
        <div class="topbar">
          <div style="display: flex; align-items: center; gap: 16px;">
            <nav id="navTabs" style="display: flex; gap: 8px;">
              <button class="btn" id="tabDiscover" title="Discover"><i class="fas fa-compass"></i> Discover</button>
              <button class="btn" id="tabLibrary" title="Library"><i class="fas fa-folder-music"></i> Library</button>
              <a class="btn" id="tabProfile" title="Profile" href="profile.html"><i class="fas fa-user"></i> Profile</a>
            </nav>
            <div class="page-title">
              <i class="fas fa-music"></i>
              <span id="pageTitle">Discover Music</span>
            </div>
          </div>
          <div class="status-bar" style="gap: 16px;">
            <span class="badge" id="resultCount">Ready to search</span>
            <span class="badge success" id="connectionStatus">Connected</span>
            <div id="profileChip" style="display:flex;align-items:center;gap:8px;">
              <img id="chipPhoto" src="" alt="User" style="width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.2)" />
              <span id="chipName" class="badge">Guest</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Results Grid -->
      <section id="results" class="results-grid"></section>

      <!-- Loading State -->
      <div id="loading" class="loading" style="display: none;">
        <div class="spinner">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <h3>Searching YouTube Music...</h3>
        <p>Finding the best tracks for you</p>
      </div>

      <!-- Empty State -->
      <div id="empty" class="empty">
        <div class="icon">
          <i class="fab fa-youtube"></i>
        </div>
        <h2>Welcome to Musico</h2>
        <p>Search for your favorite songs, artists, and albums using the search bar.</p>
        <p style="margin-top: 16px; font-size: 14px; opacity: 0.7;">
          <i class="fas fa-rocket"></i> Powered by YouTube Data API v3
        </p>
      </div>

      <!-- Library Views -->
      <section id="library" style="display:none; padding: 24px;">
        <div class="sidebar-card" style="margin-bottom:16px;">
          <div class="card-title"><i class="fas fa-heart"></i> Liked</div>
        </div>
        <div id="likedGrid" class="results-grid"></div>

        <div class="sidebar-card" style="margin:24px 0 16px;">
          <div class="card-title"><i class="fas fa-clock"></i> Recently Played</div>
        </div>
        <div id="recentGrid" class="results-grid"></div>

        <div class="sidebar-card" style="margin:24px 0 16px;">
          <div class="card-title"><i class="fas fa-list"></i> Playlists</div>
          <div style="display:flex; gap:8px;">
            <input id="newPlaylistName" class="search-input" placeholder="New playlist name" style="max-width:320px;" />
            <button id="btnCreatePlaylist" class="btn"><i class="fas fa-plus"></i> Create</button>
          </div>
        </div>
        <div id="playlistsContainer" class="results-grid"></div>
      </section>

      <!-- Profile View -->
      <section id="profile" style="display:none; padding: 24px;">
        <div class="sidebar-card">
          <div class="card-title"><i class="fas fa-user"></i> Profile</div>
          <div style="display:flex; gap:16px; align-items:center;">
            <img id="profilePhoto" src="" alt="User" style="width:80px;height:80px;border-radius:16px;object-fit:cover;border:1px solid rgba(255,255,255,.2)" />
            <div>
              <div style="font-size:20px;font-weight:700;" id="profileName">Guest</div>
              <div style="color:var(--muted)" id="profileEmail">Not signed in</div>
              <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
                <span class="badge" id="statLiked">0 liked</span>
                <span class="badge" id="statRecent">0 recent</span>
                <span class="badge" id="statPlaylists">0 playlists</span>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Player -->
    <footer class="player">
      <div class="now-playing">
        <div class="np-thumb" id="npThumb">
          <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/4daea6b1-fc07-420d-b858-c38a64088b3f.png" alt="Music player placeholder showing dark gradient background with musical note icon" />
        </div>
        <div class="np-info">
          <div class="np-title" id="npTitle">No song selected</div>
          <div class="np-artist" id="npArtist">Choose a track to start listening</div>
        </div>
      </div>

      <div class="player-controls">
        <div class="control-buttons">
          <button class="control-btn" id="btnShuffle" title="Shuffle">
            <i class="fas fa-random"></i>
          </button>
          <button class="control-btn" id="btnPrev" title="Previous">
            <i class="fas fa-step-backward"></i>
          </button>
          <button class="control-btn play" id="btnPlay" title="Play/Pause">
            <i id="icoPlay" class="fas fa-play"></i>
            <i id="icoPause" class="fas fa-pause" style="display: none;"></i>
          </button>
          <button class="control-btn" id="btnNext" title="Next">
            <i class="fas fa-step-forward"></i>
          </button>
          <button class="control-btn" id="btnRepeat" title="Repeat">
            <i class="fas fa-redo-alt"></i>
          </button>
        </div>
        
        <div class="seek-container">
          <span class="time-display" id="currentTime">0:00</span>
          <input type="range" id="seekSlider" min="0" max="100" value="0" step="0.1" />
          <span class="time-display" id="totalTime">0:00</span>
        </div>
      </div>

      <div class="volume-container">
        <i class="fas fa-volume-up volume-icon" id="volumeIcon"></i>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" step="1" value="50" />
      </div>
    </footer>
  </div>

  <!-- Hidden YouTube Player -->
  <div id="youtube-player"></div>

  <!-- YouTube IFrame Player API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // === Configuration ===
    // Firebase Config - replace with your own project values
    const firebaseConfig = {
      apiKey: "YOUR_FIREBASE_API_KEY",
      authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
      projectId: "YOUR_FIREBASE_PROJECT_ID",
      storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
      messagingSenderId: "YOUR_FIREBASE_SENDER_ID",
      appId: "YOUR_FIREBASE_APP_ID"
    };

    const API_KEY = (localStorage.getItem('MUSICO_YT_API_KEY') || 'AIzaSyBYWg0tVJaS0SRJgUUtj07VUQG1y3fv7b4');
    const STATE_KEY = 'musico-youtube-state-v3';

    // === App State ===
    const state = JSON.parse(localStorage.getItem(STATE_KEY) || '{}');
    state.queue = state.queue || [];
    state.currentIndex = state.currentIndex || 0;
    state.shuffle = state.shuffle || false;
    state.repeat = state.repeat || 'all';
    state.volume = typeof state.volume === 'number' ? state.volume : 50;
    state.isPlaying = state.isPlaying || false;
    state.currentVideoId = state.currentVideoId || null;
    state.pendingPlay = state.pendingPlay || false;

    function saveState() {
      localStorage.setItem(STATE_KEY, JSON.stringify(state));
    }

    // === Elements ===
    const $ = (id) => document.getElementById(id);
    const searchInput = $('searchInput');
    const searchBtn = $('searchBtn');
    const resultsEl = $('results');
    const emptyEl = $('empty');
    const loadingEl = $('loading');
    const resultCount = $('resultCount');
    const connectionStatus = $('connectionStatus');
    const pageTitle = $('pageTitle');
    const queueInfo = $('queueInfo');
    const tabDiscover = $('tabDiscover');
    const tabLibrary = $('tabLibrary');
    const tabProfile = $('tabProfile');
    const libraryEl = $('library');
    const profileEl = $('profile');
    const likedGrid = $('likedGrid');
    const recentGrid = $('recentGrid');
    const playlistsContainer = $('playlistsContainer');
    const newPlaylistName = $('newPlaylistName');
    const btnCreatePlaylist = $('btnCreatePlaylist');
    const chipPhoto = document.getElementById('chipPhoto');
    const chipName = document.getElementById('chipName');
    const profilePhoto = $('profilePhoto');
    const profileName = $('profileName');
    const profileEmail = $('profileEmail');
    const statLiked = $('statLiked');
    const statRecent = $('statRecent');
    const statPlaylists = $('statPlaylists');

    const btnPlay = $('btnPlay');
    const icoPlay = $('icoPlay');
    const icoPause = $('icoPause');
    const btnPrev = $('btnPrev');
    const btnNext = $('btnNext');
    const btnShuffle = $('btnShuffle');
    const btnRepeat = $('btnRepeat');
    const seekSlider = $('seekSlider');
    const currentTime = $('currentTime');
    const totalTime = $('totalTime');
    const volumeSlider = $('volumeSlider');
    const volumeIcon = $('volumeIcon');
    const npTitle = $('npTitle');
    const npArtist = $('npArtist');
    const npThumb = $('npThumb');
    // Toast
    const toastEl = document.createElement('div');
    toastEl.className = 'toast';
    document.body.appendChild(toastEl);
    function showToast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=> toastEl.classList.remove('show'), 2200); }

    // === YouTube Player ===
    let player;
    let playerReady = false;
    let currentVideoData = null;
    let isUpdatingSeek = false;
    let playerStateInterval;
    let lastSearchQuery = '';

    // === Local profile/data ===
    const LS_PROFILE = 'musico-profile';
    const LS_LIKES = 'musico-likes';
    const LS_RECENTS = 'musico-recents';
    const LS_PLAYLISTS = 'musico-playlists';
    const readLS = (k, f)=>{ try{ return JSON.parse(localStorage.getItem(k)||'') ?? f; }catch(_){ return f; } };
    const writeLS = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){} };

    // === Utilities ===
    const formatTime = (seconds) => {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    const showError = (message) => {
      console.error(message);
      connectionStatus.textContent = 'Error';
      connectionStatus.className = 'badge error';
    };

    function updateProfileChip(){
      const prof = readLS(LS_PROFILE, {});
      const display = prof.displayName || 'Guest';
      const photo = prof.photoURL || 'https://ui-avatars.com/api/?background=0B0B0C&color=fff&name=' + encodeURIComponent(display);
      if (chipPhoto) chipPhoto.src = photo;
      if (chipName) chipName.textContent = display;
      profileName.textContent = display;
      profileEmail.textContent = 'Local profile';
      profilePhoto.src = photo;
    }

    async function signInWithGoogle() {
      if (!auth) return;
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      await auth.signInWithPopup(provider);
    }

    async function signOutNow() {
      if (!auth) return;
      await auth.signOut();
    }

    async function ensureUserDoc() {
      if (!db || !currentUser) return;
      const docRef = db.collection('users').doc(currentUser.uid);
      const snap = await docRef.get();
      if (!snap.exists) {
        await docRef.set({
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          displayName: currentUser.displayName || null,
          email: currentUser.email || null
        });
      }
    }

    // === Library (LocalStorage) ===
    async function likeTrack(video) {
      const likes = readLS(LS_LIKES, []);
      if (!likes.find(v => v.id === video.id)) {
        likes.unshift({ ...video, likedAt: Date.now() });
        writeLS(LS_LIKES, likes.slice(0, 500));
      }
      await updateStats();
      return true;
    }

    async function unlikeTrack(videoId) {
      const likes = readLS(LS_LIKES, []);
      writeLS(LS_LIKES, likes.filter(v => v.id !== videoId));
      await updateStats();
      return true;
    }

    async function addRecent(video) {
      const recents = readLS(LS_RECENTS, []);
      const filtered = recents.filter(v => v.id !== video.id);
      filtered.unshift({ ...video, playedAt: Date.now() });
      writeLS(LS_RECENTS, filtered.slice(0, 500));
      await updateStats();
    }

    async function createPlaylist(name) {
      const playlists = readLS(LS_PLAYLISTS, []);
      const id = 'pl_' + Date.now().toString(36);
      playlists.unshift({ id, name, createdAt: Date.now(), tracks: [] });
      writeLS(LS_PLAYLISTS, playlists);
      await updateStats();
      return id;
    }

    async function addToPlaylist(playlistId, video) {
      const playlists = readLS(LS_PLAYLISTS, []);
      const p = playlists.find(p => p.id === playlistId);
      if (!p) return false;
      if (!p.tracks) p.tracks = [];
      if (!p.tracks.find(t => t.id === video.id)) {
        p.tracks.unshift({ ...video, addedAt: Date.now() });
        writeLS(LS_PLAYLISTS, playlists);
      }
      return true;
    }

    async function getPlaylists() {
      return readLS(LS_PLAYLISTS, []);
    }

    async function loadLibrary() {
      const likes = readLS(LS_LIKES, []);
      renderVideoGrid(likedGrid, likes);
      const recents = readLS(LS_RECENTS, []);
      renderVideoGrid(recentGrid, recents);
      const playlists = readLS(LS_PLAYLISTS, []);
      renderPlaylists(playlists);
      await updateStats(likes.length, recents.length, playlists.length);
    }

    function clearLibraryViews() {
      likedGrid.innerHTML = '';
      recentGrid.innerHTML = '';
      playlistsContainer.innerHTML = '';
      statLiked.textContent = '0 liked';
      statRecent.textContent = '0 recent';
      statPlaylists.textContent = '0 playlists';
    }

    async function updateStats(likedCount, recentCount, playlistCount) {
      if (likedCount === undefined) likedCount = (readLS(LS_LIKES, [])).length;
      if (recentCount === undefined) recentCount = (readLS(LS_RECENTS, [])).length;
      if (playlistCount === undefined) playlistCount = (readLS(LS_PLAYLISTS, [])).length;
      statLiked.textContent = `${likedCount || 0} liked`;
      statRecent.textContent = `${recentCount || 0} recent`;
      statPlaylists.textContent = `${playlistCount || 0} playlists`;
    }

    const updateQueueInfo = () => {
      const queueLength = state.queue.length;
      if (queueLength === 0) {
        queueInfo.textContent = 'No songs in queue';
      } else {
        const current = state.currentIndex + 1;
        queueInfo.textContent = `Track ${current} of ${queueLength}`;
      }
    };

    const updateVolumeIcon = () => {
      const vol = parseInt(volumeSlider.value);
      if (vol === 0) {
        volumeIcon.className = 'fas fa-volume-mute volume-icon';
      } else if (vol < 50) {
        volumeIcon.className = 'fas fa-volume-down volume-icon';
      } else {
        volumeIcon.className = 'fas fa-volume-up volume-icon';
      }
    };

    // === YouTube API - Fixed search function for more accurate results ===
    async function fetchWithRetry(url, options = {}, retries = 3, backoffMs = 600) {
      let attempt = 0;
      let lastError;
      while (attempt <= retries) {
        try {
          const res = await fetch(url, options);
          if (!res.ok) {
            const body = await res.json().catch(() => ({}));
            throw new Error(`HTTP ${res.status} ${res.statusText} ${body.error?.message ? '- ' + body.error.message : ''}`);
          }
          return await res.json();
        } catch (e) {
          lastError = e;
          if (attempt === retries) break;
          await new Promise(r => setTimeout(r, backoffMs * Math.pow(2, attempt)));
          attempt++;
        }
      }
      throw lastError;
    }

    // Rate limiter: 10 tokens/min (~1 per 6s)
    const RateLimiter = () => { let t=10; const max=10; setInterval(()=>{ t=Math.min(max,t+1); },6000); return { tryTake(){ if(t>0){ t--; return true;} return false; } }; };
    const searchLimiter = RateLimiter();

    const searchYouTube = async (query, maxResults = 24) => {
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&videoCategoryId=10&order=relevance&videoEmbeddable=true&videoSyndicated=true&maxResults=${maxResults}&key=${API_KEY}`;
      try {
        if (!searchLimiter.tryTake()) {
          showToast('Rate limit: please wait a few seconds');
          return [];
        }
        const data = await fetchWithRetry(url, {}, 2, 700);
        return (data.items || []).filter(it => it?.id?.videoId);
      } catch (error) {
        console.error('YouTube API Error:', error);
        showError('Search failed. Check API key or network and retry.');
        return [];
      }
    };

    // === YouTube Player Setup ===
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('youtube-player', {
        height: '1',
        width: '1',
        playerVars: {
          autoplay: 0,
          controls: 0,
          disablekb: 1,
          fs: 0,
          modestbranding: 1,
          rel: 0,
          iv_load_policy: 3,
          playsinline: 1
        },
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
          onError: onPlayerError
        }
      });
    }

    function onPlayerReady() {
      playerReady = true;
      player.setVolume(state.volume);
      volumeSlider.value = state.volume;
      updateVolumeIcon();

      playerStateInterval = setInterval(updatePlayerState, 1000);

      connectionStatus.textContent = 'Ready';
      connectionStatus.className = 'badge success';
      if (localStorage.getItem('MUSICO_LOGIN_SUCCESS') === '1') {
        showToast(`Signed in as ${(auth && auth.currentUser && (auth.currentUser.displayName || auth.currentUser.email)) || 'User'}`);
        localStorage.removeItem('MUSICO_LOGIN_SUCCESS');
      }

      if (state.currentVideoId && state.queue.length > 0) {
        const videoData = state.queue[state.currentIndex];
        if (videoData) {
          loadVideoData(videoData);
          player.loadVideoById(state.currentVideoId);
          if (state.pendingPlay) {
            player.playVideo();
            state.pendingPlay = false;
          }
        }
      }
    }

    function onPlayerStateChange(event) {
      const playerState = event.data;

      switch (playerState) {
        case YT.PlayerState.PLAYING:
          state.isPlaying = true;
          icoPlay.style.display = 'none';
          icoPause.style.display = '';
          connectionStatus.textContent = 'Playing';
          connectionStatus.className = 'badge success';
          break;
        case YT.PlayerState.PAUSED:
          state.isPlaying = false;
          icoPlay.style.display = '';
          icoPause.style.display = 'none';
          connectionStatus.textContent = 'Paused';
          connectionStatus.className = 'badge';
          break;
        case YT.PlayerState.ENDED:
          connectionStatus.textContent = 'Ready';
          if (state.repeat === 'one') {
            player.seekTo(0);
            player.playVideo();
          } else {
            nextTrack(true);
          }
          break;
        case YT.PlayerState.BUFFERING:
          connectionStatus.textContent = 'Loading...';
          connectionStatus.className = 'badge';
          break;
      }

      saveState();
    }

    async function tryPlayAlternative(videoData) {
      try {
        const altQuery = `${videoData.title} ${videoData.channel}`;
        const alts = await searchYouTube(altQuery, 6);
        const first = alts.find(a => a.id && a.id.videoId && a.id.videoId !== videoData.id);
        if (first) {
          const vd = {
            id: first.id.videoId,
            title: first.snippet.title,
            channel: first.snippet.channelTitle,
            thumbnail: first.snippet.thumbnails.medium?.url || first.snippet.thumbnails.default.url,
            description: first.snippet.description
          };
          playVideo(vd.id, vd);
          return true;
        }
      } catch (_) {}
      return false;
    }

    function onPlayerError(event) {
      console.error('YouTube Player Error:', event.data);
      const code = event.data;
      let message = 'Playback error';
      if (code === 2) message = 'Invalid video parameter';
      if (code === 5) message = 'HTML5 player error';
      if (code === 100) message = 'Video removed or private';
      if (code === 101 || code === 150) message = 'Playback not allowed by owner';
      connectionStatus.textContent = message;
      connectionStatus.className = 'badge error';

      // Remove offending track to avoid loops if it's an ownership restriction
      if (code === 101 || code === 150 || code === 100) {
        const current = state.queue[state.currentIndex];
        if (current) {
          state.queue.splice(state.currentIndex, 1);
          if (state.currentIndex >= state.queue.length) {
            state.currentIndex = Math.max(0, state.queue.length - 1);
          }
          saveState();
          // Try an alternative for the same song, otherwise proceed
          if (current) {
            tryPlayAlternative(current).then((played) => {
              if (!played) {
                if (state.queue.length > 0) {
                  nextTrack(true);
                }
              }
            });
            return;
          }
        }
      }

      if (state.queue.length > 1) {
        setTimeout(() => nextTrack(true), 1000);
      }
    }

    function updatePlayerState() {
      if (!playerReady || !player.getCurrentTime) return;

      try {
        const current = player.getCurrentTime() || 0;
        const duration = player.getDuration() || 0;

        currentTime.textContent = formatTime(current);
        totalTime.textContent = formatTime(duration);

        if (duration > 0 && !isUpdatingSeek) {
          seekSlider.value = (current / duration) * 100;
        }
      } catch (error) {
        console.error('Error updating player state:', error);
      }
    }

    // === Playback Functions ===
    function loadVideoData(videoData) {
      currentVideoData = videoData;
      state.currentVideoId = videoData.id;

      npTitle.textContent = videoData.title;
      npArtist.textContent = videoData.channel;

      const thumbImg = npThumb.querySelector('img');
      thumbImg.src = videoData.thumbnail;
      thumbImg.alt = `Album artwork for ${videoData.title} by ${videoData.channel}`;

      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: videoData.title,
          artist: videoData.channel,
          album: 'YouTube Music',
          artwork: [{
            src: videoData.thumbnail,
            sizes: '480x360',
            type: 'image/jpeg'
          }]
        });
      }

      updateQueueInfo();
      saveState();
      // Track as recent
      addRecent(videoData).catch(() => {});
    }

    function playVideo(videoId, videoData) {
      if (!videoId) { return; }
      // Always ensure it exists in queue and becomes current
      const existingIndex = state.queue.findIndex(v => v.id === videoId);
      if (existingIndex === -1) {
        state.queue.push(videoData);
        state.currentIndex = state.queue.length - 1;
      } else {
        state.currentIndex = existingIndex;
      }
      currentVideoData = videoData;
      state.currentVideoId = videoId;
      saveState();

      if (!playerReady) {
        state.pendingPlay = true;
        return;
      }

      loadVideoData(videoData);
      player.loadVideoById(videoId);
      try { player.playVideo(); } catch(_) {}
      state.isPlaying = true;
      saveState();
    }

    function play() {
      if (playerReady && player.playVideo) {
        player.playVideo();
      }
    }

    function pause() {
      if (playerReady && player.pauseVideo) {
        player.pauseVideo();
      }
    }

    function previousTrack() {
      if (state.queue.length === 0) return;

      let newIndex = state.currentIndex - 1;
      if (newIndex < 0) {
        newIndex = state.queue.length - 1;
      }

      state.currentIndex = newIndex;
      const video = state.queue[state.currentIndex];
      playVideo(video.id, video);
    }

    function nextTrack(fromEnded = false) {
      if (state.queue.length === 0) return;

      let newIndex;

      if (state.shuffle && !fromEnded) {
        do {
          newIndex = Math.floor(Math.random() * state.queue.length);
        } while (newIndex === state.currentIndex && state.queue.length > 1);
      } else {
        newIndex = state.currentIndex + 1;
        if (newIndex >= state.queue.length) {
          if (state.repeat === 'off' && fromEnded) {
            pause();
            return;
          }
          newIndex = 0;
        }
      }

      state.currentIndex = newIndex;
      const video = state.queue[state.currentIndex];
      playVideo(video.id, video);
    }

    // === Search Functions ===
    const performSearch = async () => {
      const query = searchInput.value.trim();
      if (!query) {
        searchInput.focus();
        return;
      }

      if (query === lastSearchQuery) {
        return;
      }

      lastSearchQuery = query;
      searchBtn.disabled = true;
      loadingEl.style.display = 'block';
      emptyEl.style.display = 'none';
      resultsEl.innerHTML = '';
      pageTitle.textContent = `Searching: "${query}"`;
      resultCount.textContent = 'Searching...';

      try {
        const results = await searchYouTube(query);
        displayResults(results, query);
      } catch (error) {
        emptyEl.style.display = 'block';
        pageTitle.textContent = 'Search Failed';
        resultCount.textContent = 'Error occurred';
      } finally {
        searchBtn.disabled = false;
        loadingEl.style.display = 'none';
      }
    };

    const displayResults = (results, query) => {
      resultsEl.innerHTML = '';

      if (results.length === 0) {
        emptyEl.style.display = 'block';
        resultCount.textContent = 'No results';
        pageTitle.textContent = 'No Results';
        return;
      }

      emptyEl.style.display = 'none';
      resultCount.textContent = `${results.length} tracks found`;
      pageTitle.textContent = `Results for "${query}"`;

      results.forEach((item, index) => {
        const videoData = {
          id: item.id.videoId,
          title: item.snippet.title,
          channel: item.snippet.channelTitle,
          thumbnail: item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default.url,
          description: item.snippet.description
        };

        const card = document.createElement('div');
        card.className = 'track-card fade-in';
        card.style.animationDelay = `${index * 0.1}s`;

        card.innerHTML = `
          <div class="track-thumb">
            <img src="${videoData.thumbnail}" alt="Music video thumbnail for ${videoData.title}" loading="lazy" />
            <div class="play-overlay">
              <button class="play-button">
                <i class="fas fa-play"></i>
              </button>
            </div>
          </div>
          <div class="track-info">
            <div class="track-title">${videoData.title}</div>
            <div class="track-channel">${videoData.channel}</div>
            <div class="track-actions">
              <button class="icon-btn add-to-queue" title="Add to queue">
                <i class="fas fa-plus"></i>
              </button>
              <button class="icon-btn like-btn" title="Like">
                <i class="fas fa-heart"></i>
              </button>
              <button class="icon-btn add-to-playlist" title="Add to playlist">
                <i class="fas fa-list"></i>
              </button>
            </div>
          </div>
        `;

        const playButton = card.querySelector('.play-button');
        playButton.onclick = (e) => {
          e.stopPropagation();
          playVideo(videoData.id, videoData);
        };

        const addButton = card.querySelector('.add-to-queue');
        addButton.onclick = (e) => {
          e.stopPropagation();

          if (state.queue.find(v => v.id === videoData.id)) {
            return;
          }

          state.queue.push(videoData);
          saveState();
          updateQueueInfo();

          addButton.innerHTML = '<i class="fas fa-check"></i>';
          addButton.className = 'icon-btn added';
          setTimeout(() => {
            addButton.innerHTML = '<i class="fas fa-plus"></i>';
            addButton.className = 'icon-btn add-to-queue';
          }, 2000);
        };

        const likeBtn = card.querySelector('.like-btn');
        likeBtn.onclick = async (e) => {
          e.stopPropagation();
          try {
            const ok = await likeTrack(videoData);
            if (ok) {
              likeBtn.classList.add('added');
              likeBtn.innerHTML = '<i class="fas fa-check"></i>';
              setTimeout(() => {
                likeBtn.classList.remove('added');
                likeBtn.innerHTML = '<i class="fas fa-heart"></i>';
              }, 1500);
            }
          } catch (_) {}
        };

        const addToPlaylistBtn = card.querySelector('.add-to-playlist');
        addToPlaylistBtn.onclick = async (e) => {
          e.stopPropagation();
          const playlists = await getPlaylists();
          let choice = null;
          if (playlists.length === 0) {
            const name = prompt('Create playlist name:');
            if (!name) return;
            choice = await createPlaylist(name.trim());
          } else {
            const options = playlists.map((p, i) => `${i+1}. ${p.name}`).join('\n');
            const answer = prompt(`Choose playlist by number or type a new name:\n${options}`);
            if (!answer) return;
            const idx = parseInt(answer, 10);
            if (!isNaN(idx) && playlists[idx-1]) {
              choice = playlists[idx-1].id;
            } else {
              choice = await createPlaylist(answer.trim());
            }
          }
          if (choice) {
            await addToPlaylist(choice, videoData);
            addToPlaylistBtn.classList.add('added');
            addToPlaylistBtn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
              addToPlaylistBtn.classList.remove('added');
              addToPlaylistBtn.innerHTML = '<i class="fas fa-list"></i>';
            }, 1500);
          }
        };

        card.onclick = () => {
          playVideo(videoData.id, videoData);
        };

        resultsEl.appendChild(card);
      });
    };

    // === Event Handlers ===
    btnPlay.onclick = () => {
      if (state.isPlaying) {
        pause();
      } else {
        if (state.queue.length > 0) {
          play();
        } else {
          searchInput.focus();
        }
      }
    };

    btnPrev.onclick = previousTrack;
    btnNext.onclick = () => nextTrack(false);

    btnShuffle.onclick = () => {
      state.shuffle = !state.shuffle;
      btnShuffle.classList.toggle('active', state.shuffle);
      saveState();
    };

    btnRepeat.onclick = () => {
      const modes = ['all', 'one', 'off'];
      const currentIndex = modes.indexOf(state.repeat);
      state.repeat = modes[(currentIndex + 1) % modes.length];

      const icon = btnRepeat.querySelector('i');
      icon.className = state.repeat === 'one' ? 'fas fa-redo' : 'fas fa-redo-alt';
      btnRepeat.classList.toggle('active', state.repeat !== 'off');
      btnRepeat.title = `Repeat: ${state.repeat}`;

      saveState();
    };

    volumeSlider.oninput = () => {
      const vol = parseInt(volumeSlider.value);
      state.volume = vol;
      updateVolumeIcon();
      if (playerReady && player.setVolume) {
        player.setVolume(vol);
      }
      saveState();
    };

    seekSlider.oninput = () => {
      if (!playerReady || !player.getDuration) return;

      isUpdatingSeek = true;
      const duration = player.getDuration();
      const seekTime = (seekSlider.value / 100) * duration;
      player.seekTo(seekTime, true);

      setTimeout(() => {
        isUpdatingSeek = false;
      }, 1000);
    };

    searchBtn.onclick = performSearch;
    searchInput.onkeypress = (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    };

    // Debounce search input to reduce API calls
    let searchDebounce;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => {
        const q = searchInput.value.trim();
        if (q && q !== lastSearchQuery) performSearch();
      }, 400);
    });

    // Keyboard shortcuts
    window.onkeydown = (e) => {
      if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;

      switch (e.code) {
        case 'Space':
          e.preventDefault();
          btnPlay.click();
          break;
        case 'ArrowRight':
          e.preventDefault();
          if (playerReady && player.getCurrentTime) {
            const current = player.getCurrentTime();
            player.seekTo(current + 10, true);
          }
          break;
        case 'ArrowLeft':
          e.preventDefault();
          if (playerReady && player.getCurrentTime) {
            const current = player.getCurrentTime();
            player.seekTo(Math.max(0, current - 10), true);
          }
          break;
        case 'ArrowUp':
          e.preventDefault();
          const newVolUp = Math.min(100, state.volume + 5);
          volumeSlider.value = newVolUp;
          volumeSlider.oninput();
          break;
        case 'ArrowDown':
          e.preventDefault();
          const newVolDown = Math.max(0, state.volume - 5);
          volumeSlider.value = newVolDown;
          volumeSlider.oninput();
          break;
        case 'KeyN':
          e.preventDefault();
          nextTrack(false);
          break;
        case 'KeyP':
          e.preventDefault();
          previousTrack();
          break;
        case 'KeyS':
          if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            searchInput.focus();
          }
          break;
      }
    };

    // Media Session
    if ('mediaSession' in navigator) {
      navigator.mediaSession.setActionHandler('play', play);
      navigator.mediaSession.setActionHandler('pause', pause);
      navigator.mediaSession.setActionHandler('previoustrack', previousTrack);
      navigator.mediaSession.setActionHandler('nexttrack', () => nextTrack(false));
      navigator.mediaSession.setActionHandler('seekto', (details) => {
        if (playerReady && player.seekTo) {
          player.seekTo(details.seekTime, true);
        }
      });
    }

    // === Initialization ===
    const init = () => {
      btnShuffle.classList.toggle('active', state.shuffle);

      const repeatIcon = btnRepeat.querySelector('i');
      repeatIcon.className = state.repeat === 'one' ? 'fas fa-redo' : 'fas fa-redo-alt';
      btnRepeat.classList.toggle('active', state.repeat !== 'off');
      btnRepeat.title = `Repeat: ${state.repeat}`;

      volumeSlider.value = state.volume;
      updateVolumeIcon();
      updateQueueInfo();

      emptyEl.style.display = 'block';
      setTimeout(() => searchInput.focus(), 500);
    };

    // Start app
    init();
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

    // Auto-save and cleanup
    setInterval(saveState, 30000);
    window.onbeforeunload = saveState;

    // === Navigation ===
    function showDiscover() {
      pageTitle.textContent = 'Discover Music';
      resultsEl.style.display = '';
      emptyEl.style.display = '';
      libraryEl.style.display = 'none';
      profileEl.style.display = 'none';
    }

    function showLibrary() {
      pageTitle.textContent = 'Your Library';
      resultsEl.style.display = 'none';
      emptyEl.style.display = 'none';
      libraryEl.style.display = '';
      profileEl.style.display = 'none';
      if (currentUser) { loadLibrary(); }
    }

    function showProfile() {
      window.location.href = 'profile.html';
    }

    tabDiscover.onclick = showDiscover;
    tabLibrary.onclick = showLibrary;

    // === Playlist creation quick action ===
    if (btnCreatePlaylist) {
      btnCreatePlaylist.onclick = async () => {
        if (!currentUser) { showError('Sign in to create playlists'); return; }
        const name = newPlaylistName.value.trim();
        if (!name) { newPlaylistName.focus(); return; }
        const id = await createPlaylist(name);
        if (id) {
          newPlaylistName.value = '';
          await loadLibrary();
        }
      };
    }

    // === Render helpers ===
    function renderVideoGrid(container, videos) {
      container.innerHTML = '';
      videos.forEach((v, i) => {
        const card = document.createElement('div');
        card.className = 'track-card fade-in';
        card.style.animationDelay = `${i * 0.05}s`;
        card.innerHTML = `
          <div class="track-thumb">
            <img src="${v.thumbnail}" alt="${v.title}" loading="lazy" />
            <div class="play-overlay">
              <button class="play-button"><i class="fas fa-play"></i></button>
            </div>
          </div>
          <div class="track-info">
            <div class="track-title">${v.title}</div>
            <div class="track-channel">${v.channel}</div>
            <div class="track-actions">
              <button class="icon-btn" title="Play"><i class="fas fa-play"></i></button>
              <button class="icon-btn" title="Like"><i class="fas fa-heart"></i></button>
            </div>
          </div>`;
        card.onclick = () => playVideo(v.id, v);
        container.appendChild(card);
      });
    }

    function renderPlaylists(playlists) {
      playlistsContainer.innerHTML = '';
      playlists.forEach((p) => {
        const card = document.createElement('div');
        card.className = 'track-card';
        card.innerHTML = `
          <div class="track-info">
            <div class="track-title">${p.name}</div>
            <div class="track-channel" style="display:flex;gap:8px;align-items:center;">
              <i class="fas fa-list"></i> Playlist
            </div>
            <div class="track-actions">
              <button class="icon-btn" title="Open"><i class="fas fa-folder-open"></i></button>
            </div>
          </div>`;
        card.onclick = async () => {
          const vids = (p.tracks || []);
          pageTitle.textContent = `Playlist: ${p.name}`;
          resultsEl.style.display = 'none';
          emptyEl.style.display = 'none';
          profileEl.style.display = 'none';
          libraryEl.style.display = '';
          renderVideoGrid(likedGrid, vids);
        };
        playlistsContainer.appendChild(card);
      });
    }

    // Clear queue
    const btnClearQueue = document.getElementById('btnClearQueue');
    btnClearQueue.onclick = () => {
      state.queue = [];
      state.currentIndex = 0;
      state.currentVideoId = null;
      state.isPlaying = false;
      updateQueueInfo();
      saveState();
      try { if (playerReady) { player.stopVideo(); } } catch(_) {}
      npTitle.textContent = 'No song selected';
      npArtist.textContent = 'Choose a track to start listening';
    };

    // Initialize profile chip
    updateProfileChip();
  </script>
</body>
</html>

